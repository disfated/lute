# Working docs for Lute v3 in Python/Flask

Planned successor to https://github.com/jzohrab/lute

**Currently in exploratory development only!**

# Plan outline

* DONE
  * basic flask setup
  * sqlalchemy
  * configuration file management
  * pyunit and test_ database
  * db migrations
  * makefile
  * strangler pattern method with nginx reverse proxy
* Remaining
  * pylint
  * sort out distribution/installation/upgrade, and data folder management.
  * contact test users

## Strangler pattern: Gradual migration from Lute PHP to Lute v3 Flask

The strangler pattern is best here because we can build on top of a working system (Lute v2), gradually moving everything over to Flask and Lute v3.

Using this pattern, both applications are run at the same time on different ports: Lute v2 php on localhost:9999, and Lute v3 flask on localhost:5000 (or similar).  Both share the same database and migration files.  Nginx, running on localhost:8080, handles all incoming requests, and routes them to v3 if possible, or falls back to php v2.  The routing is described in the nginx.conf file in this directory.

The existing Lute v2 integration tests also use the Nginx reverse proxy URL, so that the integration tests ensure that the new v3 functionality works as expected.  See "Strangler integration testing with Panther" below.

When the migration is complete, the v2 integration tests using Panther can also be rewritten to use a Python equivalent.  They _could_ also stay in Panther if needed for the time being.

As v3 functionality is updated (including unit tests!) the nginx config file is gradually updated to use the new v3 endpoints.

When all endpoints have been moved to v3, nginx will no longer be necessary.


# Requirements

Python 3

# Install

```
python3 -m venv .venv
source .venv/bin/activate

# Install dependencies (some from other git repos, see requirements.txt)
pip install -r requirements.txt

deactivate
```

# Unit testing

```
source .venv/bin/activate  # if needed

pip install -e py_src/
make test

deactivate  # if needed
```

Run tests and see printouts

```
make testprint
```

Specific test

```
make test ARGS="-k test_name_here"
```

# Strangler integration testing with Panther

Summary:

- start the PHP web server
- start the Python web server
- start nginx reverse proxy
- run tests, going through the nginx reverse proxy.  Note the acceptance test base has a check for V3_STRANGLE_USING_NGINX .env file key.

```
# In tab #1
composer dev:start

# In tab #2 (with env activated), start luteV3
python py_src/lute_v3.py

# In tab #3, from lute_dev root, start nginx, then run a test
nginx -c `pwd`/docs/nginx.conf

composer test:v3:group smoketestbook
```

When done:

* in tab #2: Ctrl-C to break
* tab #3: nginx -s stop